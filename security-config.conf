# MAXIMUM SECURITY CONFIGURATION
# ðŸš« COMPREHENSIVE SECURITY MEASURES

# Block common exploit attempts
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to sensitive files
<FilesMatch "\.(sql|db|sqlite|env|git|svn|DS_Store)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block script execution in uploads
<Directory "uploads/">
    <FilesMatch "\.(php|jsp|asp|exe|scr|com|bat|cmd|vbs|js)$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>
</Directory>

# Block common attack patterns
RewriteEngine On

# Block SQL injection attempts
RewriteCond %{QUERY_STRING} (\'|%27|%3D|%22|%3C|%3E|%00|\*|\(|\)|union|select|insert|cast|declare|drop|update|md5|benchmark|script|javascript|vbscript|onload|onerror) [NC]
RewriteRule .* - [F,L]

# Block XSS attempts
RewriteCond %{QUERY_STRING} (<|%3C)(script|iframe|object|embed|link|meta|style|form|input|select|textarea) [NC]
RewriteRule .* - [F,L]

# Block directory traversal
RewriteCond %{REQUEST_URI} (\.\./|\.\.) [NC]
RewriteRule .* - [F,L]

# Block access to admin areas
RewriteRule ^(admin|wp-admin|administrator|admincp|adminpanel|cpanel|controlpanel|webadmin|webmaster|sysadmin|moderator|root|su|superuser|god|devil|demon|hell|hack|exploit|attack|malware|virus|trojan|worm|backdoor|rootkit|spyware|adware|keylogger|ransomware|ddos|botnet|phishing|spam|scam) - [F,L]

# Block suspicious file extensions
RewriteRule \.(exe|bat|cmd|scr|pif|com|vbs|js|jar|war|ear|class|dll|so|deb|rpm|tar|gz|zip|rar|7z|iso|img|dmg|pkg|app|apk|ipa|exe|msi|dmg|pkg|deb|rpm)$ - [F,L]

# Block suspicious user agents
RewriteCond %{HTTP_USER_AGENT} (sqlmap|nikto|nmap|masscan|dirbuster|gobuster|acunetix|openvas|nessus|qualys|rapid7|metasploit|burpsuite|owasp|wpscan|joomlavs|drupal|wordpress|magento|shopify|woocommerce|prestashop|opencart|moodle|blackwidow|black.?widow) [NC]
RewriteRule .* - [F,L]

# Block malware signatures
RewriteCond %{HTTP_USER_AGENT} (malware|virus|trojan|worm|backdoor|rootkit|spyware|adware|botnet|ddos|ransomware|keylogger|exploit|hack|attack|pentest|scan|recon|crawl|spider|bot|crawler|scraper) [NC]
RewriteRule .* - [F,L]

# Rate limiting (basic)
RewriteCond %{REQUEST_METHOD} POST
RewriteCond %{REQUEST_URI} ^/api/
RewriteCond %{HTTP:X-Forwarded-For} ^(.*)$
RewriteRule .* - [E=IP:%1]
RewriteCond %{ENV:IP} ^(.*)$
RewriteCond %{TIME} ^([0-9]+)$
RewriteCond %1,%{TIME} ^([^,]+),([0-9]+)$
RewriteCond %2,%{TIME} ^([0-9]+),([0-9]+)$
RewriteCond %3 ^([0-9]+)$
RewriteCond %4 -gt 100 [NC] # More than 100 requests per minute
RewriteRule .* - [F,L]

# Security headers (Apache)
<IfModule mod_headers.c>
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Content Type Options
    Header always set X-Content-Type-Options "nosniff"

    # Frame Options
    Header always set X-Frame-Options "DENY"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # CSP (basic)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'"

    # Remove server signature
    Header always unset X-Powered-By
    Header always unset Server

    # Anti-clickjacking
    Header always set X-Frame-Options "DENY"

    # Anti-MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Anti-XSS
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# Disable directory listing
Options -Indexes

# Prevent access to .htaccess
<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

# Prevent access to wp-config.php (if migrated from WordPress)
<Files "wp-config.php">
    Order Allow,Deny
    Deny from all
</Files>

# Block access to sensitive directories
<Directory "node_modules/">
    Order Allow,Deny
    Deny from all
</Directory>

<Directory ".next/">
    Order Allow,Deny
    Deny from all
</Directory>

<Directory ".git/">
    Order Allow,Deny
    Deny from all
</Directory>

# PHP security (if applicable)
<IfModule mod_php.c>
    php_flag register_globals off
    php_flag allow_url_fopen off
    php_flag allow_url_include off
    php_flag display_errors off
    php_flag log_errors on
    php_value error_log /var/log/php_error.log
    php_flag magic_quotes_gpc off
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
</IfModule>

# WordPress security (if applicable)
<IfModule mod_rewrite.c>
    RewriteRule ^wp-admin/includes/ - [F,L]
    RewriteRule !^wp-includes/ - [S=3]
    RewriteRule ^wp-includes/[^/]+\.php$ - [F,L]
    RewriteRule ^wp-includes/js/tinymce/langs/.+\.php - [F,L]
    RewriteRule ^wp-includes/theme-compat/ - [F,L]
</IfModule>

# Block XML-RPC attacks (WordPress)
<Files "xmlrpc.php">
    Order Allow,Deny
    Deny from all
</Files>

# Block author scans (WordPress)
RewriteRule ^author/ - [F,L]

# Block login brute force
RewriteCond %{REQUEST_METHOD} POST
RewriteCond %{REQUEST_URI} ^/api/auth/login
RewriteCond %{HTTP:X-Forwarded-For} ^(.*)$
RewriteRule .* - [E=LOGIN_IP:%1]
RewriteCond %{ENV:LOGIN_IP} ^(.*)$
RewriteCond %{TIME} ^([0-9]+)$
RewriteCond %1,%{TIME} ^([^,]+),([0-9]+)$
RewriteCond %2,%{TIME} ^([0-9]+),([0-9]+)$
RewriteCond %3 ^([0-9]+)$
RewriteCond %4 -gt 5 [NC] # More than 5 login attempts per minute
RewriteRule .* - [F,L]

# Emergency lockdown (uncomment to activate)
# RewriteRule .* - [F,L]

# Log security events
<IfModule mod_log_config.c>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Real-IP}i\"" security
    CustomLog /var/log/apache2/security.log security
</IfModule>