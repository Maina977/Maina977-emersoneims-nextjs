/**
 * Malware & Attack Protection Module
 *
 * COPYRIGHT NOTICE:
 * Copyright (c) 2024-2026 Generator Oracle. All Rights Reserved.
 */

// Common attack patterns to block
export const MALWARE_PATTERNS = {
  // SQL Injection patterns
  sqlInjection: [
    /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|UNION|ALTER|CREATE|TRUNCATE)\b)/gi,
    /(\b(OR|AND)\s+\d+\s*=\s*\d+)/gi,
    /(--|#|\/\*|\*\/)/g,
    /(\b(EXEC|EXECUTE|XP_|SP_)\b)/gi,
    /('|\"|;|\||`)/g,
  ],

  // XSS patterns
  xss: [
    /<script[\s\S]*?>[\s\S]*?<\/script>/gi,
    /javascript:/gi,
    /on\w+\s*=/gi,
    /<iframe[\s\S]*?>/gi,
    /<object[\s\S]*?>/gi,
    /<embed[\s\S]*?>/gi,
    /eval\s*\(/gi,
    /document\.cookie/gi,
    /document\.write/gi,
    /innerHTML\s*=/gi,
  ],

  // Path traversal
  pathTraversal: [
    /\.\.\//g,
    /\.\.%2[fF]/g,
    /%2e%2e%2f/gi,
    /\.\.%252[fF]/g,
  ],

  // Command injection
  commandInjection: [
    /[;&|`$]/g,
    /\|\|/g,
    /&&/g,
    /\$\(/g,
    /`.*`/g,
  ],

  // LDAP injection
  ldapInjection: [
    /[()\\*]/g,
    /\x00/g,
  ],

  // XML injection
  xmlInjection: [
    /<!DOCTYPE/gi,
    /<!ENTITY/gi,
    /<!\[CDATA\[/gi,
  ],

  // Header injection
  headerInjection: [
    /\r\n/g,
    /%0d%0a/gi,
    /%0D%0A/gi,
  ],
};

// Sanitize input against common attacks
export function sanitizeInput(input: string, type: 'query' | 'body' | 'path' = 'body'): string {
  if (!input || typeof input !== 'string') return '';

  let sanitized = input;

  // Remove null bytes
  sanitized = sanitized.replace(/\x00/g, '');

  // Encode HTML entities
  sanitized = sanitized
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');

  // Remove control characters
  sanitized = sanitized.replace(/[\x00-\x1F\x7F]/g, '');

  return sanitized;
}

// Check if input contains malicious patterns
export function containsMaliciousPatterns(input: string): { isMalicious: boolean; type: string | null } {
  if (!input || typeof input !== 'string') {
    return { isMalicious: false, type: null };
  }

  for (const [type, patterns] of Object.entries(MALWARE_PATTERNS)) {
    for (const pattern of patterns) {
      if (pattern.test(input)) {
        return { isMalicious: true, type };
      }
    }
  }

  return { isMalicious: false, type: null };
}

// Validate file uploads
export function validateFileUpload(file: {
  name: string;
  type: string;
  size: number;
}): { isValid: boolean; error?: string } {
  const ALLOWED_TYPES = [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp',
    'application/pdf',
    'text/plain',
    'text/csv',
  ];

  const BLOCKED_EXTENSIONS = [
    '.exe', '.bat', '.cmd', '.com', '.pif', '.scr',
    '.vbs', '.vbe', '.js', '.jse', '.wsf', '.wsh',
    '.ps1', '.psm1', '.psd1', '.msi', '.msp', '.mst',
    '.dll', '.sys', '.drv', '.ocx', '.cpl',
    '.jar', '.class', '.php', '.asp', '.aspx',
    '.sh', '.bash', '.zsh', '.py', '.pl', '.rb',
  ];

  const MAX_SIZE = 10 * 1024 * 1024; // 10MB

  // Check file size
  if (file.size > MAX_SIZE) {
    return { isValid: false, error: 'File size exceeds maximum allowed size (10MB)' };
  }

  // Check MIME type
  if (!ALLOWED_TYPES.includes(file.type)) {
    return { isValid: false, error: 'File type not allowed' };
  }

  // Check extension
  const extension = '.' + file.name.split('.').pop()?.toLowerCase();
  if (BLOCKED_EXTENSIONS.includes(extension)) {
    return { isValid: false, error: 'File extension not allowed' };
  }

  // Check for double extensions
  if (file.name.match(/\.[a-z]+\.[a-z]+$/i)) {
    return { isValid: false, error: 'Double file extensions not allowed' };
  }

  return { isValid: true };
}

// Generate security tokens
export function generateSecurityToken(): string {
  const array = new Uint8Array(32);
  if (typeof crypto !== 'undefined') {
    crypto.getRandomValues(array);
  } else {
    for (let i = 0; i < 32; i++) {
      array[i] = Math.floor(Math.random() * 256);
    }
  }
  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
}

// Verify CSRF token
export function verifyCSRFToken(token: string, sessionToken: string): boolean {
  if (!token || !sessionToken) return false;
  return token === sessionToken;
}

// IP-based threat detection
const suspiciousIPs = new Set<string>();
const ipRequestCounts = new Map<string, number>();

export function trackIPActivity(ip: string, threshold: number = 1000): boolean {
  const count = ipRequestCounts.get(ip) || 0;
  ipRequestCounts.set(ip, count + 1);

  if (count > threshold) {
    suspiciousIPs.add(ip);
    return false;
  }

  return true;
}

export function isIPBlocked(ip: string): boolean {
  return suspiciousIPs.has(ip);
}

// Honeypot field validation
export function validateHoneypot(honeypotValue: string | undefined): boolean {
  // Honeypot fields should be empty - bots often fill them
  return !honeypotValue || honeypotValue === '';
}

// Request timing validation (detect automated requests)
const requestTimings = new Map<string, number[]>();

export function validateRequestTiming(sessionId: string, minInterval: number = 100): boolean {
  const now = Date.now();
  const timings = requestTimings.get(sessionId) || [];

  // Keep last 10 timings
  if (timings.length >= 10) {
    timings.shift();
  }
  timings.push(now);
  requestTimings.set(sessionId, timings);

  // Check if requests are too fast (automated)
  if (timings.length >= 2) {
    const lastInterval = timings[timings.length - 1] - timings[timings.length - 2];
    if (lastInterval < minInterval) {
      return false;
    }
  }

  return true;
}

// Content Security Policy nonce generator
export function generateCSPNonce(): string {
  const array = new Uint8Array(16);
  if (typeof crypto !== 'undefined') {
    crypto.getRandomValues(array);
  } else {
    for (let i = 0; i < 16; i++) {
      array[i] = Math.floor(Math.random() * 256);
    }
  }
  return btoa(String.fromCharCode.apply(null, Array.from(array)));
}

// Security headers for responses
export const SECURITY_HEADERS = {
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Permissions-Policy': 'camera=(), microphone=(), geolocation=()',
  'X-DNS-Prefetch-Control': 'off',
  'X-Download-Options': 'noopen',
  'X-Permitted-Cross-Domain-Policies': 'none',
};

// Export combined security config
export const SECURITY_CONFIG = {
  maxRequestsPerMinute: 60,
  maxUploadSize: 10 * 1024 * 1024,
  sessionTimeout: 30 * 60 * 1000, // 30 minutes
  csrfTokenExpiry: 60 * 60 * 1000, // 1 hour
  rateLimitWindow: 60 * 1000, // 1 minute
  honeypotFieldName: 'website_url_field', // Hidden field for bots
};
